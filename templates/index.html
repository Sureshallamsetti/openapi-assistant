<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-900 text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Open API Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .card-hover {
      transition: all 0.3s ease;
    }
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-thumb {
      background: #6366f1;
      border-radius: 8px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(139, 92, 246, 0.1);
    }
    .typing::after {
      content: "‚†ã";
      animation: blink 1s infinite steps(1, start);
    }
    @keyframes blink {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 1; }
    }
    .markdown a {
      color: #8b5cf6;
      text-decoration: underline;
    }
    .markdown code {
      background: rgba(139, 92, 246, 0.2);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      border: 1px solid rgba(139, 92, 246, 0.3);
    }
    .markdown pre {
      background: rgba(139, 92, 246, 0.1);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(139, 92, 246, 0.2);
    }
    /* Input box styling */
    #chat-input {
      max-width: 600px;
      font-size: 0.875rem;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
    }
    #chat-form {
      margin: 0 auto;
      max-width: 640px;
    }
    /* Glassmorphism effects */
    .glass {
      background: rgba(139, 92, 246, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(139, 92, 246, 0.2);
    }
    .glass-dark {
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(139, 92, 246, 0.2);
    }
    /* Message styling */
    .user-message {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }
    .bot-message {
      background: rgba(30, 41, 59, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(139, 92, 246, 0.2);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>
<body class="h-full flex gradient-bg">

  <!-- Sidebar -->
  <aside class="w-64 glass-dark border-r border-purple-500/20 flex flex-col p-4 space-y-4">
    <button onclick="newChat()" class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 px-4 py-3 rounded-xl font-semibold text-left card-hover shadow-lg">
      ‚ú® New Chat
    </button>
    <div id="chat-list" class="flex-1 overflow-y-auto space-y-2"></div>
  </aside>

  <!-- Main Chat Window -->
  <div class="flex-1 flex flex-col">
    <!-- Header -->
    <header class="flex items-center justify-between px-6 py-4 glass-dark border-b border-purple-500/20">
      <div class="flex items-center space-x-3">
        <span class="text-3xl">ü§ñ</span>
        <div>
          <h1 class="text-xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">Open API Assistant</h1>
          <p class="text-sm text-slate-300">Your intelligent API companion</p>
        </div>
      </div>
      <div class="flex items-center space-x-3">
        <button onclick="clearHistory()" class="text-sm text-red-400 hover:text-red-300 bg-red-500/10 px-3 py-2 rounded-lg border border-red-500/20 hover:bg-red-500/20 transition">
          üóëÔ∏è Clear Chat
        </button>
      </div>
    </header>

    <!-- Chat Area -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-6">
      <!-- Welcome message when no chat is active -->
      <div id="welcome-message" class="text-center py-12">
        <div class="text-6xl mb-4">ü§ñ</div>
        <h2 class="text-2xl font-bold mb-2 bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">Welcome to Open API Assistant</h2>
        <p class="text-slate-300 mb-6">Start a new conversation or select an existing chat from the sidebar</p>
        <button onclick="newChat()" class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 px-6 py-3 rounded-xl font-semibold card-hover shadow-lg">
          üöÄ Start New Chat
        </button>
      </div>
    </main>

    <!-- Input -->
    <footer class="p-6 glass-dark border-t border-purple-500/20">
      <form id="chat-form" class="flex gap-3">
        <input id="chat-input" type="text" required placeholder="Ask me about your API..." class="flex-1 px-5 py-3 rounded-xl text-slate-800 focus:outline-none focus:ring-2 focus:ring-purple-500 shadow-lg" />
        <button type="button" id="mic-btn" class="glass hover:bg-purple-500/20 text-white px-4 py-3 rounded-xl font-semibold card-hover shadow-lg border border-purple-500/30">
          üé§
        </button>
        <button type="submit" class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 px-6 py-3 rounded-xl font-semibold card-hover shadow-lg">
          Send ‚ú®
        </button>
      </form>
    </footer>
  </div>

  <!-- Script -->
  <script>
    const chatContainer = document.getElementById('chat-container');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatList = document.getElementById('chat-list');
    const welcomeMessage = document.getElementById('welcome-message');

    let currentChatId = null;
    const STORAGE_INDEX_KEY = 'chat_sessions';

    function getChatKey(chatId) {
      return `chat_history_${chatId}`;
    }

    function formatTimestamp() {
      const now = new Date();
      return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function saveToHistory(messageObj) {
      const key = getChatKey(currentChatId);
      const history = JSON.parse(localStorage.getItem(key) || '[]');
      history.push(messageObj);
      localStorage.setItem(key, JSON.stringify(history));
    }

    function loadChatList() {
      const sessions = JSON.parse(localStorage.getItem(STORAGE_INDEX_KEY) || '[]');
      chatList.innerHTML = '';
      sessions.forEach(session => {
        const btn = document.createElement('button');
        btn.className = 'w-full text-left px-4 py-3 rounded-xl glass hover:bg-purple-500/20 flex justify-between items-center card-hover group';
        
        const title = document.createElement('span');
        title.textContent = session.title;
        title.className = 'truncate flex-1';
        
        const delBtn = document.createElement('button');
        delBtn.innerHTML = 'üóëÔ∏è';
        delBtn.title = 'Delete Chat';
        delBtn.className = 'ml-2 text-red-400 hover:text-red-300 opacity-0 group-hover:opacity-100 transition-opacity';
        delBtn.onclick = (e) => {
          e.stopPropagation();
          deleteChat(session.id);
        };

        btn.appendChild(title);
        btn.appendChild(delBtn);
        btn.onclick = () => loadChat(session.id);
        chatList.appendChild(btn);
      });
    }

    function deleteChat(chatId) {
      if (!confirm('Delete this chat permanently?')) return;
      
      // Remove chat from sessions
      let sessions = JSON.parse(localStorage.getItem(STORAGE_INDEX_KEY) || '[]');
      sessions = sessions.filter(s => s.id !== chatId);
      localStorage.setItem(STORAGE_INDEX_KEY, JSON.stringify(sessions));
      // Remove chat history
      localStorage.removeItem(getChatKey(chatId));
      if (chatId === currentChatId) {
        currentChatId = null;
        showWelcome();
      }
      loadChatList();
    }

    function loadChat(chatId) {
      currentChatId = chatId;
      welcomeMessage.style.display = 'none';
      chatContainer.innerHTML = '';
      const history = JSON.parse(localStorage.getItem(getChatKey(chatId)) || '[]');
      history.forEach(msg => {
        appendMessage(msg.sender, msg.text, false, msg.timestamp);
      });
    }

    function showWelcome() {
      chatContainer.innerHTML = `
        <div id="welcome-message" class="text-center py-12">
          <div class="text-6xl mb-4">ü§ñ</div>
          <h2 class="text-2xl font-bold mb-2 bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">Welcome to Open API Assistant</h2>
          <p class="text-slate-300 mb-6">Start a new conversation or select an existing chat from the sidebar</p>
          <button onclick="newChat()" class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 px-6 py-3 rounded-xl font-semibold card-hover shadow-lg">
            üöÄ Start New Chat
          </button>
        </div>
      `;
    }

    function clearHistory() {
      if (currentChatId) {
        if (confirm('Clear all messages in this chat?')) {
          localStorage.removeItem(getChatKey(currentChatId));
          chatContainer.innerHTML = '';
          showWelcome();
        }
      }
    }

    function newChat(title = null) {
      const newId = Date.now().toString();
      const chatTitle = title || `Chat ${new Date().toLocaleString([], { hour: '2-digit', minute: '2-digit', hour12: true })}`;
      const sessions = JSON.parse(localStorage.getItem(STORAGE_INDEX_KEY) || '[]');
      sessions.unshift({ id: newId, title: chatTitle }); // Add to beginning
      localStorage.setItem(STORAGE_INDEX_KEY, JSON.stringify(sessions));
      currentChatId = newId;
      chatContainer.innerHTML = '';
      welcomeMessage.style.display = 'none';
      loadChatList();
    }

    function appendMessage(sender, text, isTyping = false, timestamp = null) {
      // Hide welcome message when first message appears
      if (welcomeMessage) {
        welcomeMessage.style.display = 'none';
      }

      const row = document.createElement('div');
      row.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} mb-4`;

      const avatar = document.createElement('div');
      avatar.className = `w-10 h-10 glass flex items-center justify-center rounded-full text-xl shadow-lg ${sender === 'user' ? 'order-2 ml-3' : 'order-1 mr-3'}`;
      avatar.textContent = sender === 'user' ? 'üßë' : 'ü§ñ';

      const msgWrapper = document.createElement('div');
      msgWrapper.className = `max-w-lg px-5 py-3 rounded-2xl shadow-lg whitespace-pre-wrap markdown ${
        sender === 'user' ? 'user-message text-white' : 'bot-message text-white'
      } ${sender === 'user' ? 'order-1' : 'order-2'}`;

      if (isTyping) {
        msgWrapper.innerHTML = '<span class="typing">Thinking</span>';
        msgWrapper.classList.add('typing');
      } else {
        msgWrapper.innerHTML = marked.parse(text || '');
      }

      const messageContainer = document.createElement('div');
      messageContainer.className = `flex flex-col space-y-1 ${sender === 'user' ? 'items-end order-1' : 'items-start order-2'}`;
      messageContainer.appendChild(msgWrapper);

      if (!isTyping && timestamp) {
        const time = document.createElement('span');
        time.className = 'text-xs text-slate-400 mt-1 px-2';
        time.textContent = timestamp;
        messageContainer.appendChild(time);
      }

      row.appendChild(avatar);
      row.appendChild(messageContainer);

      chatContainer.appendChild(row);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      return msgWrapper;
    }

    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const message = chatInput.value.trim();
      if (!message) return;

      if (!currentChatId) {
        newChat();
      }

      const timestamp = formatTimestamp();
      appendMessage('user', message, false, timestamp);
      saveToHistory({ sender: 'user', text: message, timestamp });

      chatInput.value = '';
      const typingMsg = appendMessage('bot', '', true);

      try {
        const res = await fetch('http://localhost:8300/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });

        const data = await res.json();
        typingMsg.classList.remove('typing');
        typingMsg.innerHTML = marked.parse(data.reply || 'No reply.');
        const botTimestamp = formatTimestamp();
        const time = document.createElement('span');
        time.className = 'text-xs text-slate-400 mt-1 px-2';
        time.textContent = botTimestamp;
        typingMsg.parentElement.appendChild(time);
        saveToHistory({ sender: 'bot', text: data.reply, timestamp: botTimestamp });

        // Update chat title from first user message if still default
        const sessions = JSON.parse(localStorage.getItem(STORAGE_INDEX_KEY) || '[]');
        const currentSession = sessions.find(s => s.id === currentChatId);
        if (currentSession && currentSession.title.startsWith('Chat ')) {
          currentSession.title = message.length > 25 ? message.slice(0, 25) + '‚Ä¶' : message;
          localStorage.setItem(STORAGE_INDEX_KEY, JSON.stringify(sessions));
          loadChatList();
        }

      } catch (err) {
        typingMsg.classList.remove('typing');
        typingMsg.innerHTML = '‚ö†Ô∏è <span class="text-red-400">Error contacting the server. Please try again.</span>';
      }
    });

    const micBtn = document.getElementById('mic-btn');

    micBtn.addEventListener('click', () => {
      if (!('webkitSpeechRecognition' in window)) {
        alert("Speech recognition not supported in this browser.");
        return;
      }

      const recognition = new webkitSpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onstart = () => {
        micBtn.innerHTML = 'üéôÔ∏è';
        micBtn.classList.add('bg-red-500/20');
      };

      recognition.onresult = async (event) => {
        micBtn.innerHTML = 'üé§';
        micBtn.classList.remove('bg-red-500/20');
        const transcript = event.results[0][0].transcript;
        chatInput.value = transcript;

        if (!currentChatId) {
          newChat();
        }

        const timestamp = formatTimestamp();
        appendMessage('user', transcript, false, timestamp);
        saveToHistory({ sender: 'user', text: transcript, timestamp });

        const typingMsg = appendMessage('bot', '', true);

        try {
          const res = await fetch('http://localhost:8300/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: transcript })
          });

          const data = await res.json();
          typingMsg.classList.remove('typing');
          typingMsg.innerHTML = marked.parse(data.reply || 'No reply.');
          const botTimestamp = formatTimestamp();
          const time = document.createElement('span');
          time.className = 'text-xs text-slate-400 mt-1 px-2';
          time.textContent = botTimestamp;
          typingMsg.parentElement.appendChild(time);
          saveToHistory({ sender: 'bot', text: data.reply, timestamp: botTimestamp });
        } catch (err) {
          typingMsg.classList.remove('typing');
          typingMsg.innerHTML = '‚ö†Ô∏è <span class="text-red-400">Error contacting the server. Please try again.</span>';
        }
      };

      recognition.onerror = () => {
        micBtn.innerHTML = 'üé§';
        micBtn.classList.remove('bg-red-500/20');
        alert('Error during speech recognition.');
      };

      recognition.onend = () => {
        micBtn.innerHTML = 'üé§';
        micBtn.classList.remove('bg-red-500/20');
      };

      recognition.start();
    });

    // On page load
    loadChatList();
    showWelcome();

  </script>

</body>
</html>